---
const clarityId = import.meta.env.PUBLIC_CLARITY_ID;
---
<script define:vars={{ clarityId }}>
    function activateClarity() {
        if (!clarityId) {
            console.error("Clarity ID ist nicht definiert");
            return; // Verhindert Fehler, wenn clarityId nicht definiert ist
        }
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", clarityId);
        window.clarity('consent');
        console.log("Clarity sollte jetzt aktiviert sein");
    }

    function blockClarity() {
        // Versuchen, die Clarity-Funktion aufzurufen, ohne Fehler zu werfen
        if (typeof window.clarity === 'function') {
            window.clarity('decline');
            console.log("Clarity wurde blockiert.");
        } else {
            console.log("Clarity ist nicht definiert, aber die Blockierung wurde angefordert.");
        }
    }

    function setUserChoice(choice) {
        localStorage.setItem('cookieConsent', choice);
        sessionStorage.setItem('bannerShown', 'true');
        document.cookie = `cookieConsent=${choice}; path=/; max-age=31536000`; // 1 Jahr Ablauf
        hideBanner();

        if (choice === 'accepted') {
            activateClarity();
            // Check if gtag is defined before calling it
            if (typeof gtag === 'function') {
                gtag('consent', 'update', {
                    'ad_storage': 'granted',
                    'analytics_storage': 'granted',
                    'ad_user_data': 'granted',
                    'ad_personalization': 'granted'
                });
            } else {
                console.error("gtag ist nicht definiert");
            }
        } else if (choice === 'declined') {
            blockClarity();
            // Check if gtag is defined before calling it
            if (typeof gtag === 'function') {
                gtag('consent', 'update', {
                    'ad_storage': 'denied',
                    'analytics_storage': 'denied',
                    'ad_user_data': 'denied',
                    'ad_personalization': 'denied'
                });
            } else {
                console.error("gtag ist nicht definiert");
            }
        }
    }


    // Google Tag Manager
    (function(w,d,s,l,i){
        w[l]=w[l]||[];
        w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
        f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-ZZVNRP2YS0');
    // End Google Tag Manager

    function showBanner() {
        document.getElementById('cookieBanner').classList.remove('hidden');
    }

    function hideBanner() {
        document.getElementById('cookieBanner').classList.add('hidden');
    }

    function checkBannerVisibility() {
        const userChoice = localStorage.getItem('cookieConsent');
        const bannerShown = sessionStorage.getItem('bannerShown');

        if (!userChoice && !bannerShown) {
            showBanner();
        } else if (!userChoice && bannerShown) {
            showBanner();
        } else {
            hideBanner();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkBannerVisibility();

        document.getElementById('acceptCookies').addEventListener('click', () => setUserChoice('accepted'));
        document.getElementById('declineCookies').addEventListener('click', () => setUserChoice('declined'));
        document.getElementById('closeBanner').addEventListener('click', () => {
            sessionStorage.setItem('bannerShown', 'true');
            hideBanner();
        });
    });

    document.addEventListener('astro:after-swap', () => {
        checkBannerVisibility();
    });
</script>

