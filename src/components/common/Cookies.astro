---
const clarityId = import.meta.env.PUBLIC_CLARITY_ID;
---

<div id="cookieBanner" class="fixed bottom-0 right-0 sm:mb-4 sm:mr-4 m-2 cookie-banner hidden bg-page">
    <div class="shadow-lg p-4 border border-[var(--color-border)] bg-skin-fill sm:w-96 w-full">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center">
          <img src="https://www.svgrepo.com/show/401340/cookie.svg" alt="Cookie" class="h-6 w-6 mr-2" />
          <span class="font-bold text-sm">Cookie Policy</span>
        </div>
        <button id="closeBanner" class="text-sm">&times;</button>
      </div>
      <p class="text-sm">
        By accepting cookies, you're helping me experiment and analyze; decline if you prefer less tracking. For details: <a href="/dse">Privacy Policy</a>.
      </p>
      <button id="acceptCookies" class="mt-4 font-bold py-2 px-4 border border-skin-fill border-opacity-40 hover:border-skin-accent">
        Accept
      </button>
      <button id="declineCookies" class="mt-4 py-2 px-4 hover:underline">
        Decline
      </button>
    </div>
  </div>
  
  <script define:vars={{ clarityId }}>
    function initializeClarity(consentStatus) {
      if (typeof clarityId !== 'string' || clarityId.trim() === '') {
        console.error('Clarity ID ist nicht korrekt definiert');
        return;
      }
  
      (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", clarityId);
  
      window.clarity(consentStatus);
    }
  
    function activateClarity() {
      initializeClarity('consent');
    }
  
    function blockClarity() {
      initializeClarity('decline');
    }
  
    function setUserChoice(choice) {
      localStorage.setItem('cookieConsent', choice);
      sessionStorage.setItem('bannerShown', 'true');
      document.cookie = `cookieConsent=${choice}; path=/; max-age=31536000`; // 1 year expiration
      hideBanner();
  
      if (choice === 'accepted') {
        activateClarity();
      } else if (choice === 'declined') {
        blockClarity();
      }
    }
  
    function showBanner() {
      document.getElementById('cookieBanner').classList.remove('hidden');
    }
  
    function hideBanner() {
      document.getElementById('cookieBanner').classList.add('hidden');
    }
  
    function checkBannerVisibility() {
      const userChoice = localStorage.getItem('cookieConsent');
      const bannerShown = sessionStorage.getItem('bannerShown');
  
      if (!userChoice && !bannerShown) {
        showBanner();
      } else if (!userChoice && bannerShown) {
        showBanner();
      } else {
        hideBanner();
      }
    }
  
    document.addEventListener('DOMContentLoaded', () => {
      checkBannerVisibility();
  
      document.getElementById('acceptCookies').addEventListener('click', () => setUserChoice('accepted'));
      document.getElementById('declineCookies').addEventListener('click', () => setUserChoice('declined'));
      document.getElementById('closeBanner').addEventListener('click', () => {
        sessionStorage.setItem('bannerShown', 'true');
        hideBanner();
      });
    });
  
    // Überprüfen Sie die Banner-Sichtbarkeit bei jeder Navigation
    document.addEventListener('astro:after-swap', checkBannerVisibility);
  </script>